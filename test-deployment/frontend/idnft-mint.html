<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ID NFT 6551 é“¸é€ å¹³å°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .erc6551-badge {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
        }

        .wallet-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .wallet-info {
            display: none;
            margin-top: 15px;
        }

        .wallet-info.show {
            display: block;
        }

        .address {
            background: #e9ecef;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9em;
            word-break: break-all;
            margin: 10px 0;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin: 5px 0;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            box-shadow: 0 10px 20px rgba(108, 117, 125, 0.3);
        }

        .btn-erc6551 {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .btn-erc6551:hover {
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .nft-preview {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .nft-image {
            width: 200px;
            height: 200px;
            border-radius: 15px;
            margin: 0 auto 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3em;
            font-weight: bold;
        }

        .account-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .account-info h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .network-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9em;
            text-align: center;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .features {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .features h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .feature-list {
            list-style: none;
        }

        .feature-list li {
            padding: 5px 0;
            color: #666;
        }

        .feature-list li:before {
            content: "âœ… ";
            color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ID NFT 6551</h1>
            <p>é“¸é€ ä½ çš„ä¸“å±ERC-6551èº«ä»½NFT</p>
            <div class="erc6551-badge">ERC-6551 Token Bound Account</div>
        </div>

        <div class="features">
            <h3>ğŸš€ ERC-6551 ç‰¹æ€§</h3>
            <ul class="feature-list">
                <li>æ¯ä¸ªNFTéƒ½æœ‰è‡ªå·±çš„é’±åŒ…åœ°å€</li>
                <li>NFTå¯ä»¥æŒæœ‰å…¶ä»–ä»£å¸å’ŒNFT</li>
                <li>æ”¯æŒå¤æ‚çš„äº¤äº’å’Œäº¤æ˜“</li>
                <li>çœŸæ­£çš„æ•°å­—èº«ä»½è§£å†³æ–¹æ¡ˆ</li>
            </ul>
        </div>

        <div class="wallet-section">
            <button id="connectWallet" class="btn">è¿æ¥é’±åŒ…</button>
            <div id="walletInfo" class="wallet-info">
                <div class="network-info" id="networkInfo">ç½‘ç»œ: æœªè¿æ¥</div>
                <div>é’±åŒ…åœ°å€: <div class="address" id="walletAddress"></div></div>
                <div>ä½™é¢: <span id="walletBalance">0</span> USDT</div>
            </div>
        </div>

        <div id="mintSection" style="display: none;">
            <div class="form-group">
                <label for="contractAddress">åˆçº¦åœ°å€:</label>
                <input type="text" id="contractAddress" placeholder="è¾“å…¥å·²éƒ¨ç½²çš„ERC-6551åˆçº¦åœ°å€">
            </div>

            <div class="form-group">
                <label for="recipientAddress">æ¥æ”¶åœ°å€:</label>
                <input type="text" id="recipientAddress" placeholder="NFTæ¥æ”¶åœ°å€">
            </div>

            <button id="mintNFT" class="btn btn-erc6551">é“¸é€  ERC-6551 ID NFT</button>
            <button id="checkNFT" class="btn btn-secondary">æŸ¥è¯¢æˆ‘çš„ NFT</button>
            <button id="checkAccount" class="btn btn-secondary">æŸ¥è¯¢ NFT è´¦æˆ·</button>
        </div>

        <div id="status" class="status" style="display: none;"></div>

        <div id="nftPreview" class="nft-preview" style="display: none;">
            <div class="nft-image">ğŸ«</div>
            <h3>ID NFT #<span id="tokenId">1</span></h3>
            <p id="nftMetadata">æ­£åœ¨åŠ è½½å…ƒæ•°æ®...</p>
            <div id="accountInfo" class="account-info" style="display: none;">
                <h4>ğŸ”— ERC-6551 è´¦æˆ·ä¿¡æ¯</h4>
                <p>è´¦æˆ·åœ°å€: <span id="accountAddress"></span></p>
                <p>è´¦æˆ·ä½™é¢: <span id="accountBalance">0</span> USDT</p>
            </div>
        </div>
    </div>

    <script>
        let provider, signer, contract;
        const CONTRACT_ABI = [
            "function createIDNFT(address to, string memory uri) external returns (uint256)",
            "function tokenURI(uint256 tokenId) public view returns (string memory)",
            "function balanceOf(address owner) public view returns (uint256)",
            "function ownerOf(uint256 tokenId) public view returns (address)",
            "function totalSupply() public view returns (uint256)",
            "function tokenByIndex(uint256 index) public view returns (uint256)",
            "function tokenOfOwnerByIndex(address owner, uint256 index) public view returns (uint256)",
            "function getAccountAddress(uint256 tokenId) external view returns (address)",
            "function getTokenIdByAccount(address accountAddress) external view returns (uint256)",
            "function getIDMetadata(uint256 tokenId) external view returns (tuple(string tokenURI, bool isActive, uint256 createdAt, uint256 updatedAt, address accountAddress))",
            "function supportsERC6551() external pure returns (bool)"
        ];

        // ç¤ºä¾‹å…ƒæ•°æ®
        const sampleMetadata = {
            "name": "ID NFT 6551 #1",
            "description": "è¿™æ˜¯ä¸€ä¸ªåŸºäºERC-6551æ ‡å‡†çš„èº«ä»½NFTï¼Œæ‹¥æœ‰è‡ªå·±çš„é’±åŒ…åœ°å€ï¼Œå¯ä»¥æŒæœ‰å…¶ä»–ä»£å¸å’ŒNFTã€‚",
            "image": "https://ipfs.io/ipfs/QmYourImageHash",
            "attributes": [
                {
                    "trait_type": "èº«ä»½ç±»å‹",
                    "value": "ERC-6551æ•°å­—å…¬æ°‘"
                },
                {
                    "trait_type": "ç¨€æœ‰åº¦",
                    "value": "ä¼ å¥‡"
                },
                {
                    "trait_type": "é“¸é€ æ—¶é—´",
                    "value": new Date().toISOString()
                },
                {
                    "trait_type": "åŒºå—é“¾",
                    "value": "Sepoliaæµ‹è¯•ç½‘"
                },
                {
                    "trait_type": "æ ‡å‡†",
                    "value": "ERC-6551"
                },
                {
                    "trait_type": "åŠŸèƒ½",
                    "value": "Token Bound Account"
                }
            ]
        };

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showStatus('è¯·å®‰è£…MetaMaské’±åŒ…', 'error');
                    return;
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                
                const address = await signer.getAddress();
                const balance = await provider.getBalance(address);
                const network = await provider.getNetwork();

                document.getElementById('walletAddress').textContent = address;
                document.getElementById('walletBalance').textContent = ethers.utils.formatEther(balance);
                document.getElementById('networkInfo').textContent = `ç½‘ç»œ: ${network.name} (Chain ID: ${network.chainId})`;
                
                document.getElementById('walletInfo').classList.add('show');
                document.getElementById('mintSection').style.display = 'block';
                document.getElementById('connectWallet').textContent = 'é’±åŒ…å·²è¿æ¥';
                document.getElementById('connectWallet').disabled = true;

                showStatus('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');

                // æ£€æŸ¥ç½‘ç»œ
                if (network.chainId !== 11155111) { // Sepolia chain ID
                    showStatus('è¯·åˆ‡æ¢åˆ°Sepoliaæµ‹è¯•ç½‘', 'error');
                }

            } catch (error) {
                showStatus('è¿æ¥é’±åŒ…å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é“¸é€ NFT
        async function mintNFT() {
            try {
                const contractAddress = document.getElementById('contractAddress').value.trim();
                const recipientAddress = document.getElementById('recipientAddress').value.trim();

                if (!contractAddress || !recipientAddress) {
                    showStatus('è¯·å¡«å†™åˆçº¦åœ°å€å’Œæ¥æ”¶åœ°å€', 'error');
                    return;
                }

                if (!ethers.utils.isAddress(contractAddress) || !ethers.utils.isAddress(recipientAddress)) {
                    showStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»¥å¤ªåŠåœ°å€', 'error');
                    return;
                }

                showStatus('æ­£åœ¨é“¸é€ ERC-6551 NFT...', 'info');
                document.getElementById('mintNFT').disabled = true;
                document.getElementById('mintNFT').innerHTML = '<span class="loading"></span> é“¸é€ ä¸­...';

                contract = new ethers.Contract(contractAddress, CONTRACT_ABI, signer);

                // æ£€æŸ¥åˆçº¦æ˜¯å¦æ”¯æŒERC-6551
                const supports6551 = await contract.supportsERC6551();
                if (!supports6551) {
                    showStatus('è¯¥åˆçº¦ä¸æ”¯æŒERC-6551æ ‡å‡†', 'error');
                    return;
                }

                // ç”Ÿæˆå…ƒæ•°æ®URIï¼ˆè¿™é‡Œä½¿ç”¨ç¤ºä¾‹æ•°æ®ï¼‰
                const metadataURI = "https://ipfs.io/ipfs/QmYourMetadataHash";
                
                const tx = await contract.createIDNFT(recipientAddress, metadataURI);
                showStatus('äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...', 'info');

                const receipt = await tx.wait();
                showStatus(`ERC-6551 NFTé“¸é€ æˆåŠŸï¼äº¤æ˜“å“ˆå¸Œ: ${receipt.transactionHash}`, 'success');

                // è·å–æ–°é“¸é€ çš„token ID
                const totalSupply = await contract.totalSupply();
                const tokenId = totalSupply.toNumber();

                // æ˜¾ç¤ºNFTé¢„è§ˆ
                showNFTPreview(tokenId, sampleMetadata);

            } catch (error) {
                showStatus('é“¸é€ å¤±è´¥: ' + error.message, 'error');
            } finally {
                document.getElementById('mintNFT').disabled = false;
                document.getElementById('mintNFT').textContent = 'é“¸é€  ERC-6551 ID NFT';
            }
        }

        // æŸ¥è¯¢NFT
        async function checkNFT() {
            try {
                const contractAddress = document.getElementById('contractAddress').value.trim();
                const address = await signer.getAddress();

                if (!contractAddress) {
                    showStatus('è¯·å¡«å†™åˆçº¦åœ°å€', 'error');
                    return;
                }

                showStatus('æ­£åœ¨æŸ¥è¯¢NFT...', 'info');
                document.getElementById('checkNFT').disabled = true;

                contract = new ethers.Contract(contractAddress, CONTRACT_ABI, provider);
                
                const balance = await contract.balanceOf(address);
                
                if (balance.toNumber() === 0) {
                    showStatus('ä½ çš„é’±åŒ…ä¸­æ²¡æœ‰ID NFT', 'info');
                    return;
                }

                // è·å–ç¬¬ä¸€ä¸ªNFTçš„token ID
                const tokenId = await contract.tokenOfOwnerByIndex(address, 0);
                const tokenURI = await contract.tokenURI(tokenId);

                showStatus(`æ‰¾åˆ° ${balance} ä¸ªID NFT`, 'success');
                showNFTPreview(tokenId.toNumber(), sampleMetadata);

            } catch (error) {
                showStatus('æŸ¥è¯¢å¤±è´¥: ' + error.message, 'error');
            } finally {
                document.getElementById('checkNFT').disabled = false;
            }
        }

        // æŸ¥è¯¢NFTè´¦æˆ·
        async function checkAccount() {
            try {
                const contractAddress = document.getElementById('contractAddress').value.trim();
                const address = await signer.getAddress();

                if (!contractAddress) {
                    showStatus('è¯·å¡«å†™åˆçº¦åœ°å€', 'error');
                    return;
                }

                showStatus('æ­£åœ¨æŸ¥è¯¢NFTè´¦æˆ·...', 'info');
                document.getElementById('checkAccount').disabled = true;

                contract = new ethers.Contract(contractAddress, CONTRACT_ABI, provider);
                
                const balance = await contract.balanceOf(address);
                
                if (balance.toNumber() === 0) {
                    showStatus('ä½ çš„é’±åŒ…ä¸­æ²¡æœ‰ID NFT', 'info');
                    return;
                }

                // è·å–ç¬¬ä¸€ä¸ªNFTçš„token ID
                const tokenId = await contract.tokenOfOwnerByIndex(address, 0);
                
                // è·å–ERC-6551è´¦æˆ·åœ°å€
                const accountAddress = await contract.getAccountAddress(tokenId);
                const accountBalance = await provider.getBalance(accountAddress);

                showStatus(`æ‰¾åˆ°ERC-6551è´¦æˆ·: ${accountAddress}`, 'success');
                
                // æ˜¾ç¤ºè´¦æˆ·ä¿¡æ¯
                document.getElementById('accountAddress').textContent = accountAddress;
                document.getElementById('accountBalance').textContent = ethers.utils.formatEther(accountBalance);
                document.getElementById('accountInfo').style.display = 'block';

            } catch (error) {
                showStatus('æŸ¥è¯¢è´¦æˆ·å¤±è´¥: ' + error.message, 'error');
            } finally {
                document.getElementById('checkAccount').disabled = false;
            }
        }

        // æ˜¾ç¤ºNFTé¢„è§ˆ
        function showNFTPreview(tokenId, metadata) {
            document.getElementById('tokenId').textContent = tokenId;
            document.getElementById('nftMetadata').innerHTML = `
                <strong>${metadata.name}</strong><br>
                ${metadata.description}<br><br>
                <strong>å±æ€§:</strong><br>
                ${metadata.attributes.map(attr => `${attr.trait_type}: ${attr.value}`).join('<br>')}
            `;
            document.getElementById('nftPreview').style.display = 'block';
        }

        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('mintNFT').addEventListener('click', mintNFT);
        document.getElementById('checkNFT').addEventListener('click', checkNFT);
        document.getElementById('checkAccount').addEventListener('click', checkAccount);

        // è‡ªåŠ¨å¡«å……æ¥æ”¶åœ°å€
        document.getElementById('recipientAddress').addEventListener('focus', async function() {
            if (signer) {
                const address = await signer.getAddress();
                this.value = address;
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦å·²è¿æ¥é’±åŒ…
        window.addEventListener('load', async function() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        connectWallet();
                    }
                } catch (error) {
                    console.log('æœªæ£€æµ‹åˆ°å·²è¿æ¥çš„é’±åŒ…');
                }
            }
        });
    </script>
</body>
</html> 